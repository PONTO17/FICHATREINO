/**
 * Lida com requisições POST para salvar um novo exercício.
 */
function doPost(e) {
  try {
    const sheet = getSheet();
    setupSheet(sheet); // Garante que os cabeçalhos existam

    // Extrai os dados enviados pelo formulário do seu app
    const workoutId = e.parameter.workoutId;
    const exerciseId = e.parameter.exerciseId;
    const exerciseName = e.parameter.exerciseName;
    const restTime = e.parameter.restTime;
    const observation = e.parameter.observation;
    const setsJSON = e.parameter.sets; // As séries já vêm como uma string JSON

    // Adiciona a nova linha na planilha
    sheet.appendRow([workoutId, exerciseId, exerciseName, restTime, observation, setsJSON]);

    return createJsonResponse({ result: 'success', message: 'Exercício salvo com sucesso.' });
  } catch (error) {
    return createJsonResponse({ result: 'error', message: error.toString() });
  }
}

/**
 * Lida com requisições GET para ler todos os exercícios salvos.
 */
function doGet(e) {
  try {
    const sheet = getSheet();
    setupSheet(sheet);

    // Se a planilha tiver apenas o cabeçalho, retorna uma lista vazia.
    if (sheet.getLastRow() <= 1) {
      return createJsonResponse({ result: 'success', data: [] });
    }

    // Pega todos os dados da planilha, exceto o cabeçalho.
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();

    // Mapeia os dados para um formato de objeto que o seu app entende.
    const exercises = data.map(row => ({
      workoutId: row[0],
      id: row[1],
      name: row[2],
      restTime: row[3],
      observation: row[4],
      sets: JSON.parse(row[5] || '[]') // Converte a string JSON de volta para um objeto
    }));

    return createJsonResponse({ result: 'success', data: exercises });
  } catch (error) {
    return createJsonResponse({ result: 'error', message: error.toString() });
  }
}

/**
 * Configura a planilha, criando a aba e os cabeçalhos se não existirem.
 */
function setupSheet(sheet) {
  if (sheet.getLastRow() === 0) {
    const headers = [["workoutId", "exerciseId", "exerciseName", "restTime", "observation", "setsJSON"]];
    sheet.getRange(1, 1, 1, headers[0].length)
         .setValues(headers)
         .setFontWeight("bold")
         .setBackground("#d1d5db"); // Cor cinza para o cabeçalho
  }
}

/**
 * Obtém a aba de destino da planilha.
 */
function getSheet() {
  const SPREADSHEET_ID = '1bUkcQ_C1f2MQ5XnujA78tT1-jsdaIi3JAy_1dcz8uC8';
  const SHEET_NAME = 'WorkoutsDB'; // Nome da nova aba para organização
  
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = spreadsheet.getSheetByName(SHEET_NAME);

  if (!sheet) {
    sheet = spreadsheet.insertSheet(SHEET_NAME);
  }
  return sheet;
}

/**
 * Cria uma resposta padrão em formato JSON.
 */
function createJsonResponse(payload) {
  return ContentService
    .createTextOutput(JSON.stringify(payload))
    .setMimeType(ContentService.MimeType.JSON);
}
